VPN ProxyVM with ExpressVPN
===========================
sys_template=t-fedora-33-sys
dvm_sys_template=t-fedora-33-sys-dvm
appvm=sys-vpn-dvm
netvm=sys-net-dvm
fwvm=sys-fw-dvm

Note:
See setup of sys-vms to build the t-fedora-33-sys & t-fedora-33-sys-dvm-template

# 1) install VPN script in templatevm
qvm-prefs $sys_template netvm $netvm
qvm-run --auto --pass-io --no-gui --user root $sys_template  \
   'mkdir -p /rw/config/vpn && \
    cd /root && \
    git clone https://github.com/tasket/Qubes-vpn-support.git && \
    cd Qubes-vpn-support && \
    bash ./install'
qvm-prefs $sys_template netvm ''
qvm-shutdown --wait $sys_template

# 2) configure disposable vm template

#set bind dirs in DVM template
qvm-run --auto --pass-io --user root $dvm_sys_template 'xterm -e \
  "mkdir -p /rw/config/qubes-bind-dirs.d && \
   mkdir -p /rw/config/vpn"'
qvm-run --auto --pass-io --user root $dvm_sys_template 'xterm -e "nano /rw/config/qubes-bind-dirs.d/50_user.conf"'
# add: binds+=( '/usr/lib/qubes' )
# add: binds+=( '/rw/config/vpn' )
qvm-shutdown --wait $dvm_sys_template

# edit the qubes-vpn-setup script and disable check of proxy VM in the config section (disable IF check)
qvm-run --auto --pass-io --user root $dvm_sys_template 'xterm -e "nano /usr/lib/qubes/qubes-vpn-setup"'

# download OpenVPN config for ExpressVPN to /rw/config/vpn
# link the config file for use with qubes-vpn-script
qvm-run --auto --pass-io --user root $dvm_sys_template \
   'cd /rw/config/vpn && ln -s my_expressvpn* vpn-client.conf'

# run config script and add your credentials
qvm-run --auto --pass-io --user root $dvm_sys_template 'xterm -e "/usr/lib/qubes/qubes-vpn-setup --config"'
qvm-shutdown --wait $dvm_sys_template

# Create Disposable sys-vpn-dvm
qvm-create -C DispVM -l orange --template $dvm_sys_template $appvm
qvm-prefs $appvm memory 400
qvm-prefs $appvm maxmem 1024
qvm-prefs $appvm vcpus 1
qvm-prefs $appvm netvm $netvm
qvm-features $appvm appmenus-dispvm ''
qvm-prefs $appvm provides_network true
qvm-service $appvm vpn-handler-openvpn on

# Starting up the disposable sys-vpn-dvm should establish a tunnel
qvm-start $appvm

# Use the sys-vpn-dvm as net-vm for sys-firewall
qvm-prefs $fwvm netvm $appvm



###### old stuff ##########


How to use a ProxyVM to run all traffix through PIA
===================================================

template=fedora-29-minimal
# sys-vpn - a Proxy VM to hide your traffic from your ISP

Setup of a VPN-ProxyVM to use Private Internet Access to tunnel all traffic through this VPN provider.
This script will build the ProxyVM from scratch using my own t-fedora-29-minimal template and the excellent script from "tasket"

Links:
- https://github.com/tasket/Qubes-vpn-support
- https://www.qubes-os.org/doc/vpn/

```
# A ProxyVM based on my custom fedora-30-minimal sys-template

Template=t-fedora-33-sys
AppVM=sys-vpn
#FirewallVM=sys-mirage-fw

# Remove an existing AppVM   
if [ -d /var/lib/qubes/appvms/$AppVM ];
   then qvm-kill $AppVM;
   qvm-remove --force $AppVM;
fi

qvm-create --template=$Template --label=blue $AppVM
qvm-prefs --set $AppVM provides_network True 

qvm-run --auto --pass-io --no-gui --user root $AppVM \
  'mkdir -p /rw/config/vpn && \
   cd /root && \
   git clone https://github.com/tasket/Qubes-vpn-support.git && \
   cd Qubes-vpn-support && \
   bash ./install'

qvm-run --auto --pass-io --no-gui --user root $AppVM \
  'cd /rw/config/vpn && \
   wget https://www.privateinternetaccess.com/openvpn/openvpn-ip.zip && \
   unzip openvpn-ip.zip && \
   # Link to your favorite VPN-Entry Point here: && \
   ln -s Switzerland.ovpn vpn-client.conf'

# Add "vpn-handler-openvpn" to the Settinvpn-handler-opgs > Services Tab
qvm-service $AppVM vpn-handler-openvpn on

qvm-shutdown --wait $AppVM
qvm-prefs --set $AppVM netvm sys-net
qvm-start $AppVM

qvm-prefs --set $FirewallVM netvm $AppVM
qvm-prefs --get $FirewallVM netvm

```

Connect to a Cisco AnyConnect VPN automatically from CLI using OpenConnect
==========================================================================

Content of /rw/config/qubes-firewall-user-script:
```
#!/bin/sh

# This script is called in AppVMs after every firewall update (configuration
# change, starting some VM etc). This is a good place to write own custom
# firewall rules, in addition to autogenerated ones. Remember that in most cases
# you'll need to insert the rules at the beginning (iptables -I) for it to be
# effective.

## Qubes VPN
## https://www.qubes-os.org/doc/vpn/
iptables -I FORWARD -o eth0 -j DROP
iptables -I FORWARD -i eth0 -j DROP
ip6tables -I FORWARD -o eth0 -j DROP
ip6tables -I FORWARD -i eth0 -j DROP
```


Content of /rw/config/rc.local

```
#!/bin/sh

# This script will be executed at every VM startup, you can place your own
# custom commands here. This includes overriding some configuration in /etc,
# starting services etc.

# Example for overriding the whole CUPS configuration:
#  rm -rf /etc/cups
#  ln -s /rw/config/cups /etc/cups
#  systemctl --no-block restart cups

# Connect automatically per VPN
# https://www.qubes-os.org/doc/vpn/
# Automatically connect to the VPN once Internet is up
while ! ping -c 1 -W 1 1.1.1.1; do
   sleep 1
done

## Autoconnect using a network Manager profile
#PWDFILE="/rw/config/NM-system-connections/secrets/passwd-file.txt"
#nmcli connection up <VPNPROFILENAME> passwd-file $PWDFILE

## Autoconnect using Openconnect from CLI
VPNHost=<HOSTNAME>
VPNUser=<USERNAME>
VPNServerCert=<CERTIFICATE-FINGERPRINT>
PWDFILE="/rw/config/secrets/password.txt"
openconnect $VPNHost --protocol=anyconnect --user=$VPNUser --servercert=$VPNServerCert --passwd-on-stdin < $PWDFILE
```
Content of /rw/config/secrets/password.txt'
```
<YOUR-PASSWORD>
```


